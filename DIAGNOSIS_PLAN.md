## 问题诊断清单

### 当前状况
- n8n同时转发消息到两个端点：`/webhook/telegram` 和 `/webhook/telegram-tasks`
- 添加机器人时积分正常增加
- 移除机器人时积分未减少
- 数据库迁移已运行

### 可能原因
1. **事件处理问题**：移除事件未被正确捕获
2. **任务匹配问题**：chat_id格式不匹配导致找不到对应任务
3. **状态更新问题**：任务状态更新失败
4. **积分计算问题**：积分计算未正确处理revoked状态
5. **缓存问题**：积分显示有缓存延迟

### 检查步骤
1. **确认事件是否到达**：检查服务器日志中的webhook请求
2. **确认任务匹配**：验证chat_id是否能正确匹配到任务
3. **确认状态更新**：检查数据库中任务状态是否更新为revoked
4. **确认积分计算**：验证积分计算是否考虑了revoked状态
5. **检查数据一致性**：确认任务数据格式是否统一

### 已实施的修复
- [x] 增强了chat_id匹配逻辑，支持数值和字符串比较
- [x] 增加了详细日志记录
- [x] 在主控制器中也添加了移除事件处理
- [x] 优化了积分计算逻辑，考虑revoked任务

### 建议的验证步骤
1. 触发一次机器人移除事件
2. 检查服务器日志中的相关记录
3. 查询数据库中对应任务的状态变化
4. 验证用户积分是否更新